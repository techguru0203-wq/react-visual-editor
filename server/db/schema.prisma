generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String               @id @default(cuid())
  email                    String               @unique
  username                 String
  department               Department?
  role                     UserRole             @default(EMPLOYEE)
  specialty                String?
  velocity                 Int?                 @default(10)
  status                   RecordStatus         @default(ACTIVE)
  meta                     Json                 @default("{}")
  createdAt                DateTime             @default(now()) @map("created_at")
  updatedAt                DateTime             @updatedAt @map("updated_at")
  organizationId           String               @map("organization_id")
  firstname                String
  lastname                 String
  subscriptionStatus       SubscriptionStatus   @default(ACTIVE) @map("subscription_status")
  subscriptionTier         SubscriptionTier     @default(FREE) @map("subscription_tier")
  googleAuthId             String?              @map("google_auth_id")
  jiraUserId               String?              @unique @map("jira_user_id")
  referralCode             String?              @unique @default(dbgenerated("generate_unique_referral_code()")) @map("referral_code") @db.VarChar(8)
  chatSessions             ChatSession[]
  comments                 Comment[]
  creditActions            CreditAction[]
  documentPermissions      DocumentPermission[]
  createdDocuments         Document[]
  IssueChangeHistory       IssueChangeHistory[]
  createdIssues            Issue[]              @relation("createdBy")
  ownedIssues              Issue[]              @relation("ownedBy")
  payments                 Payment[]
  projectPermissions       ProjectPermission[]
  createdProjects          Project[]            @relation("createdProjects")
  ownedProjects            Project[]            @relation("ownedProjects")
  specialties              Specialty[]
  createdTemplateDocuments TemplateDocument[]
  createdTemplateIssues    TemplateIssue[]
  createdTemplateProjects  TemplateProject[]
  teams                    UserTeam[]
  organization             Organization         @relation(fields: [organizationId], references: [id])
  createdWorkPlans         WorkPlan[]           @relation("createdWorkPlans")
  ownedWorkPlans           WorkPlan[]           @relation("ownedWorkPlans")
  referralPayments         ReferralPayment[]    @relation("referralPayments")
  referredBy               Referral?            @relation("referredBy")
  hasReferred              Referral[]           @relation("hasReferred")
  hasSecondaryReferred     Referral[]           @relation("hasSecondaryReferred")
  sqlAuditLogs             SqlAuditLog[]
  createdKnowledgeBases    KnowledgeBase[]
  uploadedKnowledgeFiles   KnowledgeBaseFile[]

  @@index([organizationId, email, role, specialty, status, subscriptionTier])
  @@map("users")
}

model Organization {
  id                       String             @id @default(cuid())
  name                     String?
  description              String?
  website                  String?
  status                   RecordStatus       @default(ACTIVE)
  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")
  meta                     Json               @default("{}")
  availableSeats           Int                @default(0) @map("available_seats")
  subscriptionEnd          DateTime?          @map("subscription_end")
  subscriptionStart        DateTime?          @map("subscription_start")
  subscriptionStatus       SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionTier         SubscriptionTier   @default(FREE) @map("subscription_tier")
  totalSeats               Int                @default(1) @map("total_seats")
  stripeCustomerId         String?            @unique @map("stripe_customer_id")
  credits                  Int                @default(0)
  subscriptionInterval     String?            @map("subscription_interval")
  monthFreeCreditUsed      Int                @default(0)
  lastFreeCreditRunOutDate DateTime?
  apiKey                   String?            @default(cuid()) @map("api_key")

  creditActions     CreditAction[]
  documents         Document[]
  issues            Issue[]
  payments          Payment[]
  projects          Project[]
  specialties       Specialty[]
  teams             Team[]
  templateDocuments TemplateDocument[]
  templateProjects  TemplateProject[]
  users             User[]
  workPlans         WorkPlan[]
  DesignStyle       DesignStyle[]
  knowledgeBases    KnowledgeBase[]

  @@index([subscriptionTier, subscriptionStatus, apiKey, status, stripeCustomerId])
  @@map("organizations")
}

model Team {
  id             String       @id @default(cuid())
  name           String       @unique
  description    String?
  status         RecordStatus @default(ACTIVE)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organizationId String       @map("organization_id")
  parentTeamId   String?      @map("parent_team_id")
  meta           Json         @default("{}")
  projects       Project[]
  organization   Organization @relation(fields: [organizationId], references: [id])
  parentTeam     Team?        @relation("parentTeam", fields: [parentTeamId], references: [id])
  childTeams     Team[]       @relation("parentTeam")
  members        UserTeam[]

  @@index([organizationId, parentTeamId])
  @@map("teams")
}

model UserTeam {
  status    RecordStatus @default(ACTIVE)
  meta      Json         @default("{}")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  userId    String       @map("user_id")
  teamId    String       @map("team_id")
  team      Team         @relation(fields: [teamId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@id([userId, teamId])
  @@map("userTeams")
}

model TemplateProject {
  id             String          @id @default(cuid())
  name           String
  tags           String          @default("")
  description    String?
  rating         Int             @default(0)
  use_count      Int             @default(0)
  meta           Json?           @default("{}")
  status         ProjectStatus   @default(CREATED)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  organizationId String          @map("organization_id")
  creatorUserId  String          @map("creator_user_id")
  access         TemplateAccess  @default(ORGANIZATION)
  projects       Project[]
  templateIssues TemplateIssue[]
  creator        User            @relation(fields: [creatorUserId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])

  @@index([organizationId, creatorUserId])
  @@map("templateProjects")
}

model TemplateIssue {
  id                 String                    @id @default(cuid())
  name               String
  description        String?
  depth              Int                       @default(1)
  fields             Json?                     @default("{}")
  status             IssueStatus               @default(CREATED)
  meta               Json?                     @default("{}")
  createdAt          DateTime                  @default(now()) @map("created_at")
  updatedAt          DateTime                  @updatedAt @map("updated_at")
  templateProjectId  String                    @map("template_project_id")
  creatorUserId      String                    @map("creator_user_id")
  type               IssueType?
  Issue              Issue[]
  templateDocument   TemplateDocument[]
  templateDependedBy TemplateIssueDependency[] @relation("templateDependedBy")
  templateDependsOn  TemplateIssueDependency[] @relation("templateDependsOn")
  creator            User                      @relation(fields: [creatorUserId], references: [id])
  templateProject    TemplateProject           @relation(fields: [templateProjectId], references: [id])

  @@index([templateProjectId, creatorUserId])
  @@map("templateIssues")
}

model TemplateIssueDependency {
  status                    RecordStatus  @default(ACTIVE)
  meta                      Json          @default("{}")
  createdAt                 DateTime      @default(now()) @map("created_at")
  updatedAt                 DateTime      @updatedAt @map("updated_at")
  dependsOnTemplateIssueId  String
  dependedByTemplateIssueId String
  dependedByTemplateIssue   TemplateIssue @relation("templateDependedBy", fields: [dependedByTemplateIssueId], references: [id])
  dependsOnTemplateIssue    TemplateIssue @relation("templateDependsOn", fields: [dependsOnTemplateIssueId], references: [id])

  @@id([dependsOnTemplateIssueId, dependedByTemplateIssueId])
  @@map("templateIssueDependencies")
}

model Project {
  id                  String                     @id @default(cuid())
  name                String
  description         String?
  storyPoint          Int?                       @map("story_point")
  dueDate             DateTime?                  @default(now()) @map("due_date")
  progress            Int?                       @default(0)
  status              ProjectStatus              @default(CREATED)
  meta                Json?                      @default("{}")
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")
  organizationId      String                     @map("organization_id")
  templateProjectId   String?                    @map("template_project_id")
  creatorUserId       String                     @map("creator_user_id")
  teamId              String?                    @map("team_id")
  ownerUserId         String?                    @map("owner_user_id")
  access              Access                     @default(SELF)
  shortName           String                     @unique
  completedStoryPoint Int?                       @default(0) @map("completed_story_point")
  jiraId              String?                    @unique @map("jira_id")
  documents           Document[]
  issues              Issue[]
  permissions         ProjectPermission[]
  creator             User                       @relation("createdProjects", fields: [creatorUserId], references: [id])
  organization        Organization               @relation(fields: [organizationId], references: [id])
  owner               User?                      @relation("ownedProjects", fields: [ownerUserId], references: [id])
  team                Team?                      @relation(fields: [teamId], references: [id])
  templateProject     TemplateProject?           @relation(fields: [templateProjectId], references: [id])
  workPlans           WorkPlan[]
  knowledgeBaseLinks  KnowledgeBaseProjectLink[]

  @@index([organizationId, creatorUserId, ownerUserId, templateProjectId, teamId])
  @@map("projects")
}

model ProjectPermission {
  id         String                   @id @default(cuid())
  projectId  String                   @map("project_id")
  email      String                   @default("")
  permission DocumentPermissionTypes  @default(VIEW)
  status     DocumentPermissionStatus @default(ACTIVE)
  createdAt  DateTime                 @default(now()) @map("created_at")
  updatedAt  DateTime                 @updatedAt @map("updated_at")
  userId     String?                  @map("user_id")
  project    Project                  @relation(fields: [projectId], references: [id])
  user       User?                    @relation(fields: [userId], references: [id])

  @@index([projectId, email])
  @@map("projectPermissions")
}

model Issue {
  id                  String               @id @default(cuid())
  name                String
  description         String?
  storyPoint          Int?                 @map("story_point")
  progress            Int                  @default(0)
  type                IssueType
  status              IssueStatus          @default(CREATED)
  meta                Json?                @default("{}")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  projectId           String               @map("project_id")
  templateIssueId     String?              @map("template_issue_id")
  parentIssueId       String?              @map("parent_issue_id")
  creatorUserId       String               @map("creator_user_id")
  ownerUserId         String?              @map("owner_user_id")
  actualEndDate       DateTime?            @map("actual_end_date")
  actualStartDate     DateTime?            @map("actual_start_date")
  completedStoryPoint Int?                 @map("completed_story_point")
  plannedEndDate      DateTime?            @map("planned_end_date")
  plannedStartDate    DateTime?            @map("planned_start_date")
  workPlanId          String?              @map("work_plan_id")
  shortName           String               @unique
  jiraId              String?              @unique @map("jira_id")
  organizationId      String?              @map("organization_id")
  comments            Comment[]
  documents           Document[]
  changeHistory       IssueChangeHistory[]
  dependedBy          IssueDependency[]    @relation("dependedBy")
  dependsOn           IssueDependency[]    @relation("dependsOn")
  creator             User                 @relation("createdBy", fields: [creatorUserId], references: [id])
  organization        Organization?        @relation(fields: [organizationId], references: [id])
  owner               User?                @relation("ownedBy", fields: [ownerUserId], references: [id])
  parentIssue         Issue?               @relation("parentIssue", fields: [parentIssueId], references: [id])
  childIssues         Issue[]              @relation("parentIssue")
  project             Project              @relation(fields: [projectId], references: [id])
  templateIssue       TemplateIssue?       @relation(fields: [templateIssueId], references: [id])
  workPlan            WorkPlan?            @relation(fields: [workPlanId], references: [id])

  @@index([projectId, workPlanId, ownerUserId, creatorUserId, organizationId, parentIssueId, status])
  @@map("issues")
}

model IssueChangeHistory {
  id                Int      @id @default(autoincrement())
  issueId           String   @map("issue_id")
  userId            String   @map("user_id")
  modifiedAttribute String   @map("modified_attribute")
  createdAt         DateTime @default(now()) @map("created_at")
  workLogId         String?  @unique @map("work_log_id")
  issue             Issue    @relation(fields: [issueId], references: [id])
  user              User     @relation(fields: [userId], references: [id])

  @@index([issueId, createdAt])
  @@map("issueChangeHistories")
}

model IssueDependency {
  status            RecordStatus @default(ACTIVE)
  meta              Json         @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  dependsOnIssueId  String
  dependedByIssueId String
  dependedBy        Issue        @relation("dependedBy", fields: [dependedByIssueId], references: [id])
  dependsOn         Issue        @relation("dependsOn", fields: [dependsOnIssueId], references: [id])

  @@id([dependsOnIssueId, dependedByIssueId])
  @@map("issueDependencies")
}

model Comment {
  id            String        @id @default(cuid())
  issueId       String        @map("issue_id")
  userId        String        @map("user_id")
  content       String        @map("content")
  replyTo       String?       @map("reply_to")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  status        CommentStatus @default(ACTIVE)
  jiraCommentId String?       @unique @map("jira_comment_id")
  issue         Issue         @relation(fields: [issueId], references: [id])
  user          User          @relation(fields: [userId], references: [id])

  @@index([issueId, userId])
  @@map("comments")
}

model WorkPlan {
  id                  String         @id @default(cuid())
  name                String
  description         String?
  type                WorkPlanType
  storyPoint          Int?           @map("story_point")
  completedStoryPoint Int?           @map("completed_story_point")
  plannedStartDate    DateTime?      @map("planned_start_date")
  plannedEndDate      DateTime?      @map("planned_end_date")
  actualStartDate     DateTime?      @map("actual_start_date")
  actualEndDate       DateTime?      @map("actual_end_date")
  progress            Int            @default(0)
  status              WorkPlanStatus @default(CREATED)
  meta                Json?          @default("{}")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  projectId           String         @map("project_id")
  creatorUserId       String         @map("creator_user_id")
  ownerUserId         String?        @map("owner_user_id")
  parentWorkPlanId    String?        @map("parent_work_plan_id")
  jiraSprintId        String?        @unique @map("jira_sprint_id")
  organizationId      String?        @map("organization_id")
  issues              Issue[]
  creator             User           @relation("createdWorkPlans", fields: [creatorUserId], references: [id])
  organization        Organization?  @relation(fields: [organizationId], references: [id])
  owner               User?          @relation("ownedWorkPlans", fields: [ownerUserId], references: [id])
  parentWorkPlan      WorkPlan?      @relation("parentWorkPlan", fields: [parentWorkPlanId], references: [id])
  childWorkPlans      WorkPlan[]     @relation("parentWorkPlan")
  project             Project        @relation(fields: [projectId], references: [id])

  @@index([projectId, parentWorkPlanId, creatorUserId, ownerUserId, organizationId])
  @@map("workPlans")
}

model TemplateDocument {
  id                       String             @id @default(cuid())
  name                     String
  description              String?
  type                     DOCTYPE
  url                      String?
  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")
  organizationId           String             @map("organization_id")
  creatorUserId            String             @map("creator_user_id")
  access                   TemplateAccess     @default(ORGANIZATION)
  images                   String[]
  meta                     Json               @default("{}")
  parentTemplateDocumentId String?            @map("parent_template_document_id")
  promptText               String?            @default("") @map("prompt_text")
  sampleInputText          String?            @map("sample_input_text")
  tags                     String[]
  useCount                 Int                @default(0) @map("use_count")
  status                   TemplateStatus     @default(CREATED)
  outputFormat             String?            @map("output_format")
  sampleOutputText         String?            @map("sample_output_text")
  templateIssueId          String?
  documents                Document[]
  creator                  User               @relation(fields: [creatorUserId], references: [id])
  organization             Organization       @relation(fields: [organizationId], references: [id])
  parentTemplateDocument   TemplateDocument?  @relation("templateDocumentParent", fields: [parentTemplateDocumentId], references: [id])
  childTemplateDocuments   TemplateDocument[] @relation("templateDocumentParent")
  TemplateIssue            TemplateIssue?     @relation(fields: [templateIssueId], references: [id])

  @@index([organizationId, creatorUserId])
  @@map("templateDocuments")
}

model Document {
  id                  String               @id @default(cuid())
  name                String
  description         String?
  content             Bytes?               @default("")
  type                DOCTYPE
  url                 String
  status              DocumentStatus       @default(CREATED)
  meta                Json?                @default("{}")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  projectId           String?              @map("project_id")
  issueId             String?              @map("issue_id")
  creatorUserId       String               @map("creator_user_id")
  templateDocumentId  String?              @map("template_document_id")
  access              Access               @default(ORGANIZATION)
  imageBase64         String?              @map("image_base_64")
  organizationId      String?              @map("organization_id")
  documentPermissions DocumentPermission[]
  documentHistory     DocumentHistory[]
  creator             User                 @relation(fields: [creatorUserId], references: [id])
  issue               Issue?               @relation(fields: [issueId], references: [id])
  organization        Organization?        @relation(fields: [organizationId], references: [id])
  project             Project?             @relation(fields: [projectId], references: [id])
  templateDocument    TemplateDocument?    @relation(fields: [templateDocumentId], references: [id])
  sqlAuditLogs        SqlAuditLog[]

  @@index([projectId, issueId, creatorUserId, organizationId, status])
  @@map("documents")
}

model DocumentHistory {
  id                 String   @id @default(cuid())
  documentId         String   @map("document_id")
  versionNumber      Int      @map("version_number")
  description        String
  fileUrl            String?  @map("file_url")
  currentVersionUrl  String?  @map("current_version_url")
  content            String?  @db.Text
  chosenDocumentIds  String?  @map("chosen_document_ids")
  rating             Json?
  creatorUserId      String   @map("creator_user_id")
  creatorEmail       String   @map("creator_email")
  createdAt          DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId, versionNumber])
  @@index([documentId, createdAt])
  @@map("documentHistories")
}

model Payment {
  id               String           @id @default(cuid())
  payerUserId      String           @map("payer_user_id")
  email            String
  subscriptionTier SubscriptionTier @map("subscription_tier")
  seats            Int?             @default(1)
  currency         String
  meta             Json             @default("{}")
  amount           Int
  invoiceId        String           @map("invoice_id")
  organizationId   String           @map("organization_id")
  status           String
  invoiceUrl       String           @map("invoice_url")
  type             String           @default("")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  eventId          String?          @map("event_id")
  organization     Organization     @relation(fields: [organizationId], references: [id])
  payer            User             @relation(fields: [payerUserId], references: [id])

  @@index([payerUserId, organizationId, type, status, eventId])
  @@map("payments")
}

model CreditAction {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  action         String       @default("")
  amount         Int
  status         String
  meta           Json         @default("{}")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([userId, organizationId, action, status])
  @@map("creditActions")
}

model Specialty {
  id             String       @id @default(cuid())
  name           String
  displayName    String       @map("display_name")
  description    String       @default("")
  organizationId String       @map("organization_id")
  creatorUserId  String       @map("creator_user_id")
  status         String       @default("ACTIVE")
  access         String       @default("ORGANIZATION")
  meta           Json         @default("{}")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  creator        User         @relation(fields: [creatorUserId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, name, status])
  @@map("specialties")
}

model DocumentPermission {
  id         String                   @id @default(cuid())
  documentId String                   @map("document_id")
  userId     String?                  @map("user_id")
  permission DocumentPermissionTypes  @default(VIEW)
  email      String                   @default("")
  status     DocumentPermissionStatus @default(ACTIVE)
  createdAt  DateTime                 @default(now()) @map("created_at")
  updatedAt  DateTime                 @updatedAt @map("updated_at")
  Document   Document                 @relation(fields: [documentId], references: [id])
  user       User?                    @relation(fields: [userId], references: [id])

  @@index([documentId, email])
  @@map("documentPermissions")
}

model ChatSession {
  id               String                      @id @default(cuid())
  userId           String                      @map("user_id")
  targetEntityId   String                      @map("target_entity_id")
  targetEntityType ChatSessionTargetEntityType @map("target_entity_type")
  status           RecordStatus                @default(ACTIVE)
  createdAt        DateTime                    @default(now()) @map("created_at")
  updatedAt        DateTime                    @updatedAt @map("updated_at")
  access           Access                      @default(SELF)
  name             String?
  chatHistory      ChatHistory[]
  user             User                        @relation(fields: [userId], references: [id])

  @@index([userId, targetEntityId, targetEntityType, status])
  @@map("chatSessions")
}

model ChatHistory {
  sessionId   String          @map("session_id")
  message     Json
  createdAt   DateTime        @default(now()) @map("created_at")
  id          Int             @id @default(autoincrement())
  messageUse  MessageUseTypes @default(BOTH)
  chatSession ChatSession     @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("chatHistories")
}

model DesignStyle {
  id             String          @id @default(cuid())
  organizationId String          @map("organization_id")
  styleInfo      Json            @map("style_info")
  sourceType     StyleSourceType @map("source_type")
  sourceUrls     String[]        @map("source_urls")
  status         RecordStatus    @map("status")
  version        Int             @default(autoincrement())
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@map("designStyles")
}

model SqlAuditLog {
  id            String   @id @default(cuid())
  documentId    String   @map("document_id")
  userId        String   @map("user_id")
  environment   String   @default("preview")
  sqlStatement  String   @map("sql_statement") @db.Text
  sqlType       String   @map("sql_type")
  status        String
  errorMessage  String?  @map("error_message") @db.Text
  rowsAffected  Int?     @map("rows_affected")
  executionTime Int?     @map("execution_time")
  createdAt     DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id])
  document Document @relation(fields: [documentId], references: [id])

  @@index([documentId, userId, environment, createdAt])
  @@map("sql_audit_logs")
}

model Referral {
  id                         String       @id @default(cuid())
  referrerUserId             String       @map("referrer_user_id")
  refereeUserId              String       @map("referee_user_id")
  secondaryReferrerUserId    String?      @map("secondary_referrer_user_id")
  referralCode               String       @map("referral_code")
  referrerCreditRewardAmount Int          @default(2000) @map("referrer_credit_reward_amount")
  commissionPercentage       Int          @default(0) @map("commission_percentage")
  status                     RecordStatus @default(ACTIVE)
  meta                       Json         @default("{}")
  createdAt                  DateTime     @default(now()) @map("created_at")
  updatedAt                  DateTime     @updatedAt @map("updated_at")

  // Relations
  referrer          User  @relation("hasReferred", fields: [referrerUserId], references: [id])
  referee           User  @relation("referredBy", fields: [refereeUserId], references: [id])
  secondaryReferrer User? @relation("hasSecondaryReferred", fields: [secondaryReferrerUserId], references: [id])

  @@unique([refereeUserId])
  // Optimized indexes for common queries
  @@index([referrerUserId, secondaryReferrerUserId]) // Find referrals by referrer
  @@map("referrals")
}

model ReferralPayment {
  id             String        @id @default(cuid())
  referrerUserId String        @map("referrer_user_id")
  month          String // Format: "YYYY-MM"
  amount         Int // Amount in cents for this specific payment
  status         PaymentStatus @default(PENDING)
  meta           Json          @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  referrer User @relation("referralPayments", fields: [referrerUserId], references: [id])

  // Optimized indexes for common queries
  @@index([referrerUserId]) // Find payments by user
  @@map("referralPayments")
}

model KnowledgeBase {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String       @map("organization_id")
  creatorUserId  String       @map("creator_user_id")
  status         RecordStatus @default(ACTIVE)
  meta           Json         @default("{}")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization               @relation(fields: [organizationId], references: [id])
  creator      User                       @relation(fields: [creatorUserId], references: [id])
  files        KnowledgeBaseFile[]
  projectLinks KnowledgeBaseProjectLink[]

  @@index([organizationId, status])
  @@map("knowledgeBases")
}

model KnowledgeBaseFile {
  id               String       @id @default(cuid())
  knowledgeBaseId  String       @map("knowledge_base_id")
  fileName         String       @map("file_name")
  fileType         String       @map("file_type")
  fileSize         Int          @map("file_size")
  s3Key            String       @map("s3_key")
  s3Url            String       @map("s3_url")
  processingStatus KBFileStatus @default(PENDING) @map("processing_status")
  chunkCount       Int          @default(0) @map("chunk_count")
  qdrantIds        String[]     @map("qdrant_ids")
  errorMessage     String?      @map("error_message")
  uploadedBy       String       @map("uploaded_by")
  meta             Json         @default("{}")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id])
  uploader      User          @relation(fields: [uploadedBy], references: [id])

  @@index([knowledgeBaseId, processingStatus])
  @@map("knowledgeBaseFiles")
}

model KnowledgeBaseProjectLink {
  id              String   @id @default(cuid())
  knowledgeBaseId String   @map("knowledge_base_id")
  projectId       String   @map("project_id")
  createdAt       DateTime @default(now()) @map("created_at")

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id])
  project       Project       @relation(fields: [projectId], references: [id])

  @@unique([knowledgeBaseId, projectId])
  @@index([projectId])
  @@map("knowledgeBaseProjectLinks")
}

enum StyleSourceType {
  IMAGE
  WEBSITE_LINK
  FIGMA_LINK
  CODEBASE_LINK
}

enum MessageUseTypes {
  CHAT
  GENERATION
  BOTH
  NONE
}

enum SubscriptionTier {
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  OVERDUE
  EXPIRED
  CANCELED
  CANCELED_YET_ACTIVE
  TRIAL
}

enum UserRole {
  SUPERADMIN
  ADMIN
  EMPLOYEE
  VIRTUALEMPLOYEE
}

enum RecordStatus {
  PENDING
  ACTIVE
  INACTIVE
  DEACTIVATED
  READ
}

enum Department {
  Product
  Engineering
  Sales
  Marketing
  Operation
}

enum Access {
  SELF
  TEAM
  ORGANIZATION
  PUBLIC
}

enum TemplateAccess {
  SELF
  ORGANIZATION
  PUBLIC
}

enum ProjectStatus {
  CREATED
  STARTED
  PAUSED
  COMPLETED
  CANCELED
}

enum IssueStatus {
  CREATED
  STARTED
  GENERATING
  INREVIEW
  APPROVED
  COMPLETED
  CANCELED
  OVERWRITTEN
}

enum IssueType {
  BUILDABLE
  EPIC
  STORY
  TASK
  SUBTASK
  BUG
}

enum CommentStatus {
  ACTIVE
  DELETED
}

enum WorkPlanType {
  MILESTONE
  SPRINT
  KANBAN
  BACKLOG
}

enum WorkPlanStatus {
  CREATED
  STARTED
  OVERWRITTEN
  COMPLETED
  CANCELED
}

enum DOCTYPE {
  PRD
  UI_DESIGN
  TECH_DESIGN
  DEVELOPMENT_PLAN
  OTHER
  QA_PLAN
  RELEASE_PLAN
  PROPOSAL
  PRODUCT
  BUSINESS
  MARKETING
  SALES
  SUPPORT
  ENGINEERING
  PROTOTYPE
}

enum DocumentStatus {
  CREATED
  INREVIEW
  APPROVED
  PUBLISHED
  CANCELED
  ARCHIVED
}

enum DocumentPermissionTypes {
  VIEW
  EDIT
}

enum DocumentPermissionStatus {
  ACTIVE
  CANCELED
}

enum TemplateStatus {
  CREATED
  PUBLISHED
  CANCELED
  ARCHIVED
}

enum ChatSessionTargetEntityType {
  DOCUMENT
  PROJECT
  ISSUE
  WORKPLAN
  CHAT
  KNOWLEDGE_BASE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  CANCELED
}

enum KBFileStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
